{% extends "base.html" %}
{% import 'bootstrap/form.html' as wtf %}

{% block styles %}
    {{super()}}
    <style>
        td.idcol {
          font-size: 8px;
        }
        </style>
{% endblock %}

{% block app_content %}
    <h1>Email.Cloud IOC API Management</h1>
    <p>This application allows you to manage indicators of compromise (IOC) in your Email.Cloud tenant.</p>
    <button type="button" id="downloadbutton" class="btn btn-primary" onclick="javascript:downloadIOC()">Retrieve IOC</button>
    <div id="iocs">

    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        function downloadIOC() {
            $('#downloadbutton').attr('disabled','disabled');
            $('#iocs').html('<img src="{{ url_for('static', filename='loading.gif') }}">');
            $.post('/ioc/download', {

            }).done(function(response) {
                if(response['status_code']==200) {
                    $('#iocs').html(response['html']);
                    var img = '';
                    var t = $('#ioctable').DataTable({
                        columnDefs: [
                            {
                                targets: 0,
                                className: 'idcol',
                                visible: false
                            },
                            {
                                targets: 2,
                                render: function (data, type, row) {
                                    switch(data) {
                                        case "Active":
                                            return '<img src="/static/active.svg" alt="' + data + '"height="16" />';
                                        default:
                                        return '<img src="/static/inactive.svg" alt="' + data + '"height="16" />';
                                    }
                                }
                            },
                            {
                                targets: 3,
                                render: function (data, type, row) {
                                    switch(data) {
                                        case "I":
                                            img='inbound.svg';
                                            return '<img src="/static/' + img + '" alt="' + data + '"height="16" />';
                                        case "O":
                                            img='outbound.svg';
                                            return '<img src="/static/' + img + '" alt="' + data + '"height="16" />';
                                        case "B":
                                            img='bidirectional.svg';
                                            return '<img src="/static/' + img + '" alt="' + data + '"height="16" />';
                                        default:
                                            return '';
                                    }
                                }
                            }
                        ]
                    } );

                    t.on( 'order.dt search.dt', function () {
                    t.column(1, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
                        cell.innerHTML = i+1;
                    } );
                    }).draw();
                    flask_moment_render_all();
                } else {
                    $('#iocs').html('<hr><div class="alert alert-danger" role="alert">ERROR ' 
                        + response['status_code'] + ': '
                        + response['error_message'] + '</div>');
                }
            }).fail(function() {
                $('#iocs').html('Error: Unable to load IOC');
            });
            $('#downloadbutton').removeAttr('disabled');
        }
    </script>
{% endblock %}